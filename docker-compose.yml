# docker-compose.yml – SpectraOps local development / single-node production
#
# Usage:
#   docker compose up -d          # start everything
#   docker compose logs -f api    # tail API logs
#   docker compose down -v        # stop & remove volumes

services:
  # ── PostgreSQL ─────────────────────────────
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: spectraops
    ports:
      - '5432:5432'
    volumes:
      - pgdata:/var/lib/postgresql/data
      # Seed the schema on first run
      - ./packages/core-engine/src/data/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 5s
      timeout: 3s
      retries: 5

  # ── Core Engine API ────────────────────────
  api:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    ports:
      - '3000:3000'
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: postgres://postgres:postgres@db:5432/spectraops
      CORS_ORIGIN: http://localhost:5173
      LOG_LEVEL: info
      RATE_LIMIT_WINDOW_MS: 60000
      RATE_LIMIT_MAX: 100
      TRUST_PROXY: 'true'
      ERROR_RETENTION_DAYS: 90
      PG_POOL_MAX: 20
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "fetch('http://localhost:3000/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
volumes:
  pgdata:
